<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error Handler</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Error Handler</h1>
        <span class="help-link" onclick="openModal()">Help / Instructions</span>
    </header>

    <!-- Add Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h1>CSV Phone Number Analyzer</h1>
            <p>A web-based tool for analyzing phone number frequencies across multiple CSV files and generating opt-out lists.</p>

            <h2>Features</h2>
            <ul>
                <li>Multiple CSV file upload support</li>
                <li>Customizable row display for previewing CSV contents</li>
                <li>Phone number frequency counter across all uploaded files</li>
                <li>Automatic opt-out list generation based on frequency threshold</li>
                <li>Customizable output filename for the opt-out list</li>
            </ul>

            <h2>Requirements</h2>
            <p>Your input CSV files must include:</p>
            <ul>
                <li>A "Phone" column header</li>
                <li>A "Name" column header</li>
                <li>Data must be comma-separated</li>
            </ul>

            <h2>How to Use</h2>
            <ol>
                <li><strong>Set Your Threshold</strong>
                    <ul>
                        <li>Enter a number in the "Threshold for opt-outs" field</li>
                        <li>This number determines how many occurrences of a phone number trigger an opt-out</li>
                        <li>Click "Set Threshold" to confirm</li>
                    </ul>
                </li>
                <li><strong>Set Output Filename</strong>
                    <ul>
                        <li>Enter your desired filename for the output CSV</li>
                        <li>The .csv extension will be added automatically</li>
                        <li>If left blank, defaults to "OptOuts.csv"</li>
                    </ul>
                </li>
                <li><strong>Upload CSV Files</strong>
                    <ul>
                        <li>Click the file upload button</li>
                        <li>Select one or multiple CSV files</li>
                        <li>A preview of each file will appear showing the first few rows</li>
                    </ul>
                </li>
                <li><strong>Generate Results</strong>
                    <ul>
                        <li>Click "Count Phone Numbers & Generate Opt-Outs"</li>
                        <li>The tool will:
                            <ul>
                                <li>Display a table showing all phone numbers and their frequencies</li>
                                <li>Automatically download a CSV file containing names and phone numbers that exceeded the threshold</li>
                            </ul>
                        </li>
                    </ul>
                </li>
            </ol>

            <h2>Notes</h2>
            <ul>
                <li>Phone numbers must match exactly to be counted as the same number</li>
                <li>For numbers that appear multiple times with different names, the first occurrence's name will be used</li>
                <li>Invalid characters in the output filename will be replaced with underscores</li>
                <li>The tool processes files locally in your browser - no data is sent to any server</li>
            </ul>
        </div>
    </div>

    <main>
        <div class="input-section">
            <h2>CSV File Upload</h2>
            <div class="input-group">
                <label for="rowCount">Threshold for opt-outs:</label>
                <input type="number" id="rowCount" min="1" value="5">
                <button id="thresholdButton" onclick="validateRowCount()">Set Threshold</button>
            </div>
            <div class="input-group">
                <label for="outputFileName">Output file name:</label>
                <input type="text" id="outputFileName" value="OptOuts" placeholder="Enter file name">
                <span>.csv</span>
            </div>
            <div class="input-group">
                <input type="file" id="csvFile" accept=".csv" multiple>
                <button onclick="countPhoneNumbers()">Count Phone Numbers & Generate Opt-Outs</button>
            </div>
        </div>

        <div class="collapsible-section">
            <button class="collapsible" id="countResults">View Phone Number Counts</button>
            <div class="content" id="phoneCount"></div>
        </div>
        <div id="fileList" class="file-list"></div>
    </main>

    <footer>
        <p>&copy; 2024 Jeremy Is Awesome. Hosted on GitHub Pages.</p>
    </footer>

    <script>
        let displayRowCount = 5;  // Now used as threshold for opt-outs
        let csvDataArray = [];  // Store all CSV data

        // Add this at the beginning to ensure the collapsible is initialized
        document.addEventListener('DOMContentLoaded', function() {
            const coll = document.getElementsByClassName("collapsible");
            for (let i = 0; i < coll.length; i++) {
                coll[i].addEventListener("click", function() {
                    this.classList.toggle("active");
                    const content = this.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            }
        });

        function validateRowCount() {
            const rowInput = document.getElementById('rowCount');
            const thresholdButton = document.getElementById('thresholdButton');
            const value = parseInt(rowInput.value);
            
            if (Number.isInteger(value) && value > 0) {
                displayRowCount = value;
                thresholdButton.textContent = "Threshold set! âœ“";
                thresholdButton.classList.add('set');
            } else {
                alert('Please enter a valid positive integer');
                rowInput.value = displayRowCount;  // Reset to last valid value
                thresholdButton.textContent = "Set Threshold";
                thresholdButton.classList.remove('set');
            }
        }

        document.getElementById('csvFile').addEventListener('change', function(e) {
            csvDataArray = [];  // Reset the array when new files are uploaded
            const files = e.target.files;
            const fileList = document.getElementById('fileList');
            fileList.innerHTML = '';  // Clear previous displays

            for (let file of files) {
                const reader = new FileReader();
                const preview = document.createElement('div');
                preview.className = 'csv-preview';
                preview.innerHTML = `<h3>${file.name}</h3>`;
                fileList.appendChild(preview);

                reader.onload = function(event) {
                    const csvData = event.target.result;
                    csvDataArray.push(csvData);  // Store the CSV data
                    const rows = csvData.split('\n');
                    const headers = rows[0].split(',');
                    
                    let table = '<table><thead><tr>';
                    headers.forEach(header => {
                        table += `<th>${header}</th>`;
                    });
                    table += '</tr></thead><tbody>';

                    for (let i = 1; i < Math.min(rows.length, displayRowCount + 1); i++) {
                        const cells = rows[i].split(',');
                        table += '<tr>';
                        cells.forEach(cell => {
                            table += `<td>${cell}</td>`;
                        });
                        table += '</tr>';
                    }
                    table += '</tbody></table>';
                    
                    if (rows.length > displayRowCount + 1) {
                        table += `<p>... (showing first ${displayRowCount} rows)</p>`;
                    }
                    
                    preview.innerHTML += table;
                };

                reader.readAsText(file);
            }
        });

        function countPhoneNumbers() {
            const phoneCounts = {};
            const optOuts = new Set();
            const optOutDetails = new Map();
            let phoneColumnIndex = -1;
            let nameColumnIndex = -1;

            csvDataArray.forEach(csvData => {
                const rows = csvData.split('\n');
                const headers = rows[0].split(',');
                
                // Find the Phone and Name column indices
                phoneColumnIndex = headers.findIndex(header => 
                    header.trim().toLowerCase() === 'phone'
                );
                nameColumnIndex = headers.findIndex(header => 
                    header.trim().toLowerCase() === 'name'
                );

                if (phoneColumnIndex === -1) {
                    alert('No "Phone" column found in one or more CSV files');
                    return;
                }
                if (nameColumnIndex === -1) {
                    alert('No "Name" column found in one or more CSV files');
                    return;
                }

                // Count phone numbers and collect names
                for (let i = 1; i < rows.length; i++) {
                    const cells = rows[i].split(',');
                    if (cells.length > Math.max(phoneColumnIndex, nameColumnIndex)) {
                        const phoneNumber = cells[phoneColumnIndex].trim();
                        const name = cells[nameColumnIndex].trim();
                        if (phoneNumber) {
                            phoneCounts[phoneNumber] = (phoneCounts[phoneNumber] || 0) + 1;
                            if (phoneCounts[phoneNumber] >= displayRowCount) {
                                optOuts.add(phoneNumber);
                                optOutDetails.set(phoneNumber, name);
                            }
                        }
                    }
                }
            });

            // Display results
            const phoneCountDiv = document.getElementById('phoneCount');
            const countResults = document.getElementById('countResults');
            
            if (Object.keys(phoneCounts).length === 0) {
                phoneCountDiv.innerHTML = '<p>No phone numbers found or no files uploaded.</p>';
                return;
            }

            let resultHtml = '<table>';
            resultHtml += '<tr><th>Phone Number</th><th>Count</th></tr>';
            
            Object.entries(phoneCounts)
                .sort(([, a], [, b]) => b - a)
                .forEach(([phone, count]) => {
                    resultHtml += `<tr><td>${phone}</td><td>${count}</td></tr>`;
                });
            
            resultHtml += '</table>';
            phoneCountDiv.innerHTML = resultHtml;
            
            // Update the collapsible button text to show count
            const totalNumbers = Object.keys(phoneCounts).length;
            countResults.textContent = `View Phone Number Counts (${totalNumbers} total)`;
            
            // Generate CSV with custom filename
            if (optOuts.size > 0) {
                let csvContent = "Name,Phone\n";
                optOuts.forEach(phone => {
                    csvContent += `${optOutDetails.get(phone)},${phone}\n`;
                });

                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                
                // Get custom filename or use default
                let fileName = document.getElementById('outputFileName').value.trim();
                fileName = fileName || 'OptOuts'; // Use 'OptOuts' if input is empty
                fileName = fileName.replace(/[^a-z0-9]/gi, '_'); // Replace invalid characters
                
                a.setAttribute('href', url);
                a.setAttribute('download', `${fileName}.csv`);
                a.click();
                window.URL.revokeObjectURL(url);
            }
        }

        // Add these modal functions
        function openModal() {
            document.getElementById('helpModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('helpModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('helpModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>
